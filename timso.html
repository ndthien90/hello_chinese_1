<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng L·ª±a ch·ªçn S·ªë Ng·∫´u Nhi√™n (1-99)</title>
    
    <!-- Google Fonts for Mulish -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- C·∫•u h√¨nh Tailwind CSS ƒë·ªÉ s·ª≠ d·ª•ng Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // B·∫≠t ch·∫ø ƒë·ªô t·ªëi b·∫±ng c√°ch th√™m class 'dark' v√†o body
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#2563EB',
                        'dark-bg': '#1f2937',
                        'dark-card': '#374151',
                    }
                }
            }
        }
    </script>
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ Mulish cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Mulish', sans-serif;
            background-color: #f1f5f9;
            transition: background-color 0.3s;
        }

        /* √Åp d·ª•ng font Ê•∑‰Ωì (Kaiti) cho H√°n t·ª± */
        #target-chinese-char {
            /* S·ª≠ d·ª•ng Ê•∑‰Ωì (Kaiti) v√† c√°c font ch·ªØ th∆∞ ph√°p kh√°c l√†m d·ª± ph√≤ng */
            font-family: Ê•∑‰Ωì, 'KaiTi', 'SimSun', serif; 
        }
        
        /* Global Dark Mode Styles */
        .dark body {
            background-color: var(--dark-bg);
        }
        .dark .main-container {
            background-color: var(--dark-card);
        }
        .dark h1 {
            color: #93c5fd; /* blue-300 */
        }
        .dark p.text-gray-600 {
            color: #d1d5db; /* gray-300 */
        }

        /* ƒê·ªãnh nghƒ©a ki·ªÉu d√°ng cho h√¨nh tr√≤n ch·ª©a s·ªë */
        .number-circle {
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            user-select: none;
            /* ƒê·∫£m b·∫£o h√¨nh tr√≤n kh√¥ng b·ªã bi·∫øn d·∫°ng khi animation */
            will-change: transform, background-color, border-color; 
        }

        .number-circle:hover:not(.correct-flash):not(.incorrect-flash):not(.hidden-circle) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3), 0 4px 6px -4px rgba(37, 99, 235, 0.2);
        }
        
        /* Keyframe cho hi·ªáu ·ª©ng nh√°y XANH (ƒê√∫ng) */
        @keyframes flash-correct {
            0%, 100% { background-color: #10b981; border-color: #047857; transform: scale(1.1); }
            50% { background-color: #34d399; border-color: #059669; }
        }
        /* Keyframe cho hi·ªáu ·ª©ng nh√°y ƒê·ªé (Sai) */
        @keyframes flash-incorrect {
            0%, 100% { background-color: #ef4444; border-color: #b91c1c; transform: scale(1.1); }
            50% { background-color: #f87171; border-color: #dc2626; }
        }

        .number-circle.correct-flash {
            animation: flash-correct 0.4s 3; /* Nh√°y 3 l·∫ßn */
            pointer-events: none; /* Kh√¥ng cho click khi ƒëang flash */
        }
        .number-circle.incorrect-flash {
            animation: flash-incorrect 0.4s 3; /* Nh√°y 3 l·∫ßn */
            pointer-events: none;
        }

        /* Hi·ªáu ·ª©ng m·ªù d·∫ßn cho c√°c s·ªë b·ªã lo·∫°i b·ªè */
        .number-circle.hidden-circle {
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
        }

        /* B·ªï sung CSS cho ph√°o gi·∫•y */
        #game-over-modal {
            /* ƒê·∫£m b·∫£o modal l√† v√πng ch·ª©a cho canvas */
            position: fixed; 
            overflow: hidden;
        }

        #fireworks-canvas {
            z-index: 5; /* N·∫±m sau n·ªôi dung modal (z-10) */
        }
    </style>
</head>
<body class="p-0 sm:p-8 min-h-screen flex flex-col items-center">

    <!-- Container ch√≠nh - Lo·∫°i b·ªè bo g√≥c v√† chi·∫øm to√†n b·ªô chi·ªÅu r·ªông tr√™n mobile -->
    <div class="main-container max-w-full sm:max-w-4xl w-full bg-white dark:bg-dark-card p-4 sm:p-10 rounded-none sm:rounded-xl shadow-2xl transition-colors">
        
        <!-- N√∫t chuy·ªÉn ƒë·ªïi giao di·ªán S√°ng/T·ªëi -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700 dark:text-blue-300">
                üöÄ Tr√≤ Ch∆°i T√¨m S·ªë
            </h1>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors shadow-md hover:shadow-lg">
                <!-- Icon M·∫∑t Tr·ªùi (S√°ng) -->
                <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Icon M·∫∑t TrƒÉng (T·ªëi) -->
                <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
        
        <!-- √î ch·ªçn s·ªë v√≤ng ch∆°i -->
        <div class="mb-4 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4">
            <label for="round-selector" class="text-gray-700 dark:text-gray-300 font-semibold">Ch·ªçn t·ªïng s·ªë v√≤ng ch∆°i:</label>
            <select id="round-selector" class="p-2 rounded-lg border-2 border-primary-blue bg-white dark:bg-gray-700 dark:text-white font-bold transition-colors shadow-sm focus:ring-2 focus:ring-primary-blue">
                <option value="5">5 V√≤ng</option>
                <option value="10">10 V√≤ng</option>
                <option value="15">15 V√≤ng</option>
                <option value="20">20 V√≤ng</option>
            </select>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã V√≤ng, TH·ªúI GIAN v√† ƒêi·ªÉm s·ªë -->
        <div class="flex justify-between items-center text-xl font-bold mb-6 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 shadow-inner">
            <span id="round-display" class="text-gray-700 dark:text-gray-300 text-base sm:text-xl">V√≤ng: 0/5</span>
            <span id="timer-display" class="text-2xl sm:text-3xl tracking-wider text-red-600 dark:text-red-400 font-extrabold">00:25s</span> 
            <span id="score-display" class="text-green-600 dark:text-green-400 text-base sm:text-xl">ƒê√∫ng: 0</span>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã S·ªê M·ª§C TI√äU (CH·ªà TI·∫æNG TRUNG) -->
        <div class="text-center mb-8 p-4 rounded-xl bg-blue-500 dark:bg-blue-700 shadow-xl">
            <p class="text-white text-lg font-semibold mb-2">S·ªë b·∫°n c·∫ßn ch·ªçn l√† (H√°n t·ª±):</p>
            <!-- H√°n t·ª± d√πng font Ê•∑‰Ωì -->
            <div id="target-chinese-display" class="mt-2 text-white text-2xl font-medium">
                <p id="target-chinese-char" class="text-yellow-200 font-extrabold text-5xl sm:text-6xl tracking-wider">??</p>
                <p id="target-chinese-pinyin" class="text-yellow-100 italic text-base sm:text-xl mt-1"></p>
                <!-- N√∫t Nghe l·∫°i -->
                <button id="speak-button" class="mt-2 px-3 py-1 bg-blue-700 hover:bg-blue-800 text-white text-sm font-semibold rounded-full disabled:opacity-50" disabled>
                    <svg class="w-4 h-4 inline-block align-text-bottom" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-4l-4 4v-4H9a1 1 0 01-1-1v-5a1 1 0 011-1h2l3-3 3 3h2zM7 7H5a1 1 0 00-1 1v2a1 1 0 001 1h2v-4z" clip-rule="evenodd"></path></svg>
                    Nghe l·∫°i
                </button>
            </div>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã th√¥ng b√°o k·∫øt qu·∫£ -->
        <div id="feedback-message" class="mb-8 p-4 text-center rounded-lg font-semibold text-xl border-l-4 hidden">
            <!-- N·ªôi dung ph·∫£n h·ªìi s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS -->
        </div>
        
        <!-- Khu v·ª±c hi·ªÉn th·ªã s·ªë ƒë√£ ch·ªçn/ch·ªù ch·ªçn -->
        <div class="mb-8 p-4 text-center rounded-lg bg-yellow-50 dark:bg-yellow-900/50 border-l-4 border-yellow-500 dark:border-yellow-400 text-yellow-800 dark:text-yellow-200 font-semibold text-base sm:text-xl">
            ƒê√£ ch·ªçn s·ªë: <span id="selected-number" class="text-blue-600 dark:text-blue-300 font-bold">Ch∆∞a c√≥</span>
        </div>

        <!-- Khu v·ª±c ch·ª©a 10 h√¨nh tr√≤n s·ªë (Responsive Layout: 4 c·ªôt tr√™n mobile, 5 c·ªôt tr√™n tablet+) -->
        <div id="numbers-container" class="w-full mx-auto border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 grid grid-cols-4 md:grid-cols-5 gap-3 sm:gap-4 justify-items-center items-center relative" style="min-height: 250px;">
            <p id="start-prompt" class="absolute inset-0 flex items-center justify-center text-lg sm:text-xl text-gray-500 dark:text-gray-400 col-span-5">
                Nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i 5 v√≤ng!
            </p>
            <!-- C√°c h√¨nh tr√≤n s·ªë s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript t·∫°i ƒë√¢y -->
        </div>

        <!-- N√∫t t·∫°o l·∫°i s·ªë v√† N√∫t Tr·ª£ gi√∫p (Responsive stacking) -->
        <div class="flex flex-col sm:flex-row justify-center mt-10 space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="help-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition-all active:scale-95 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                üí° Tr·ª£ gi√∫p 50/50
            </button>
            <button id="generate-button" class="px-6 py-3 bg-primary-blue text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all active:scale-95 text-lg">
                ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i
            </button>
        </div>
    </div>

    <!-- MODAL HI·ªÇN TH·ªä K·∫æT QU·∫¢ CU·ªêI C√ôNG -->
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <!-- Canvas cho hi·ªáu ·ª©ng ph√°o gi·∫•y -->
        <canvas id="fireworks-canvas" class="absolute inset-0 w-full h-full"></canvas>

        <div class="bg-white dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-all scale-100 relative z-10">
            <h2 id="modal-title" class="text-4xl font-extrabold text-green-600 dark:text-green-400 mb-4">üéâ Ho√†n Th√†nh!</h2>
            <p class="text-lg text-gray-700 dark:text-gray-200 mb-6">B·∫°n ƒë√£ ho√†n th√†nh <span id="modal-total-rounds">5</span> v√≤ng ch∆°i.</p>
            <p class="text-2xl font-semibold text-gray-800 dark:text-white mb-8">K·∫øt qu·∫£ cu·ªëi c√πng: <span id="final-score" class="text-blue-600 dark:text-blue-400 font-extrabold">0/5</span></p>
            <button id="restart-button-modal" class="px-6 py-3 bg-primary-blue text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all active:scale-95 text-lg">
                Ch∆°i l·∫°i
            </button>
        </div>
    </div>

    <script>
        // C√°c bi·∫øn to√†n c·ª•c
        const numbersContainer = document.getElementById('numbers-container');
        const selectedNumberDisplay = document.getElementById('selected-number');
        const feedbackMessage = document.getElementById('feedback-message');
        const generateButton = document.getElementById('generate-button');
        const helpButton = document.getElementById('help-button');
        const themeToggle = document.getElementById('theme-toggle');
        const targetChineseCharDisplay = document.getElementById('target-chinese-char');
        const targetChinesePinyinDisplay = document.getElementById('target-chinese-pinyin');
        const startPrompt = document.getElementById('start-prompt');
        const speakButton = document.getElementById('speak-button');
        const roundSelector = document.getElementById('round-selector');
        const modalTotalRoundsDisplay = document.getElementById('modal-total-rounds');
        
        // --- Speech API Variables ---
        const synth = window.speechSynthesis;
        let chineseVoice = null;
        
        // --- Game State Variables ---
        let totalRounds = 5;
        let currentRound = 0;
        let correctGuesses = 0;
        let isGameActive = false;
        let isHelpUsed = false;
        const usedTargetNumbers = new Set();
        
        // --- UI Elements for Game State ---
        const roundDisplay = document.getElementById('round-display');
        const scoreDisplay = document.getElementById('score-display');
        // NEW: Timer display element
        const timerDisplay = document.getElementById('timer-display'); 
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButtonModal = document.getElementById('restart-button-modal');

        const count = 10;
        const min = 1;
        const max = 99;
        let targetNumber = null;
        let currentSelected = null;
        let isDarkMode = false;
        
        // NEW: Timer Variables
        const TIME_PER_ROUND = 8; // 8 gi√¢y cho m·ªói v√≤ng
        let remainingTime = 0;
        let timerInterval = null;
        
        
        // D·ªØ li·ªáu chuy·ªÉn ƒë·ªïi s·ªë sang Ti·∫øng Trung v√† Pinyin (1-99)
        const unitPinyin = ['', 'yƒ´', '√®r', 'sƒÅn', 's√¨', 'w«î', 'li√π', 'qƒ´', 'bƒÅ', 'ji«î'];
        const unitChar = ['', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù'];
        const tenChar = 'ÂçÅ';
        const tenPinyin = 'sh√≠';

        // --- CONFETTI (PH√ÅO GI·∫§Y) VARIABLES ---
        const confettiCanvas = document.getElementById('fireworks-canvas'); 
        const ctx = confettiCanvas.getContext('2d');
        let particles = [];
        let animationFrameId = null; 
        
        // C√ÅC BI·∫æN KI·ªÇM SO√ÅT S·ªê L·∫¶N B·∫ÆN PH√ÅO GI·∫§Y
        let confettiBurstCount = 0;
        const maxConfettiBursts = 6; 
        
        // B·∫£ng m√†u r·ª±c r·ª° cho ph√°o gi·∫•y
        const CONFETTI_COLORS = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#ffeb3b', '#ffc107', '#ff9800'];

        // L·ªõp h·∫°t gi·∫•y (Confetti Particle)
        class ConfettiParticle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.width = Math.random() * 8 + 6; 
                this.height = Math.random() * 4 + 3;
                
                this.velocity = {
                    x: (Math.random() - 0.5) * 15, 
                    y: (Math.random() * -15) - 5 
                };
                this.gravity = 0.5; 
                this.alpha = 1;
                this.rotation = Math.random() * 360; 
                this.rotationSpeed = Math.random() * 0.1 + 0.05; 
                this.spin = Math.random() < 0.5 ? 1 : -1; 
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
                
                ctx.restore();
            }

            update() {
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                
                this.velocity.x *= 0.98;

                this.rotation += this.rotationSpeed * this.spin * 10;
                
                if (this.y > confettiCanvas.height * 1.5) {
                    this.alpha = 0; 
                } else if (this.y > confettiCanvas.height * 0.8) {
                    this.alpha -= 0.008;
                }
                
                this.draw();
            }
        }

        // T·∫°o v·ª• n·ªï gi·∫•y
        function createConfettiBurst(x, y, count = 100) {
            for (let i = 0; i < count; i++) {
                const color = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
                particles.push(new ConfettiParticle(x, y, color));
            }
        }

        // V√≤ng l·∫∑p animation ph√°o gi·∫•y
        function animateConfetti() {
            animationFrameId = requestAnimationFrame(animateConfetti);
            
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            particles.forEach((particle, index) => {
                if (particle.alpha <= 0) {
                    particles.splice(index, 1);
                } else {
                    particle.update();
                }
            });

            // CH·ªà t·∫°o burst n·∫øu ch∆∞a ƒë·∫°t ƒë·∫øn gi·ªõi h·∫°n maxConfettiBursts
            if (confettiBurstCount < maxConfettiBursts && Math.random() < 0.1) { 
                const x = Math.random() * confettiCanvas.width;
                const y = confettiCanvas.height * 0.1; 
                createConfettiBurst(x, y, 70); // B·∫Øn 70 h·∫°t/l·∫ßn
                confettiBurstCount++; // TƒÉng b·ªô ƒë·∫øm
            }
            
            // KI·ªÇM TRA ƒê·ªÇ D·ª™NG ANIMATION:
            if (confettiBurstCount >= maxConfettiBursts && particles.length === 0) {
                 stopConfetti();
                 return;
            }

            if (particles.length > 500) {
                particles = particles.slice(particles.length - 500);
            }
        }

        // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng ph√°o gi·∫•y
        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            
            if (!animationFrameId) {
                particles = []; 
                confettiBurstCount = 0; 
                animateConfetti();
            }
        }

        // D·ª´ng hi·ªáu ·ª©ng ph√°o gi·∫•y
        function stopConfetti() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                particles = [];
            }
        }
        window.addEventListener('resize', () => {
            if (animationFrameId) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        });
        // --- END CONFETTI VARIABLES ---
        
        /**
         * D·ª´ng ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c.
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                // ƒê·∫£m b·∫£o kh√¥ng c√≤n hi·ªáu ·ª©ng nh·∫•p nh√°y khi d·ª´ng
                timerDisplay.classList.remove('animate-pulse', 'text-red-500'); 
            }
        }

        /**
         * C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·ªìng h·ªì.
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}s`;
            timerDisplay.textContent = `${timeString}`;
            
            // Highlight timer color for urgency
            if (remainingTime <= 10 && remainingTime > 0) {
                 timerDisplay.classList.add('animate-pulse', 'text-red-500');
            } else {
                 timerDisplay.classList.remove('animate-pulse', 'text-red-500');
            }
        }
        
        /**
         * B·∫Øt ƒë·∫ßu ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c.
         */
        function startTimer() {
            stopTimer(); // ƒê·∫£m b·∫£o d·ª´ng timer c≈©
            
            // T√≠nh t·ªïng th·ªùi gian: V√≤ng ch∆°i * 8 gi√¢y
            remainingTime = totalRounds * TIME_PER_ROUND;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    stopTimer();
                    isGameActive = false;
                    // G·ªçi showGameOver v·ªõi th√¥ng b√°o H·∫øt gi·ªù
                    showGameOver('H·∫øt gi·ªù!');
                }
            }, 1000);
        }

        /**
         * H√†m t·∫£i gi·ªçng ƒë·ªçc ti·∫øng Trung (Mandarin Chinese).
         */
        function loadChineseVoice() {
            if (chineseVoice) return; 

            const voices = synth.getVoices();
            chineseVoice = voices.find(voice => voice.lang === 'zh-CN' || voice.name.includes('Chinese') || voice.name.includes('Mandarin'));

            if (!chineseVoice) {
                console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng ƒë·ªçc ti·∫øng Trung (zh-CN). S·∫Ω s·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh.");
            }
            speakButton.disabled = true; 
        }

        /**
         * H√†m ƒë·ªçc to vƒÉn b·∫£n H√°n t·ª±.
         */
        function speakChineseText(text) {
            if (!synth) {
                console.error("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.");
                return;
            }

            synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            utterance.voice = chineseVoice || synth.getVoices().find(v => v.lang.startsWith('zh')) || null; 
            utterance.rate = 0.8; 
            
            utterance.onend = () => {
                speakButton.disabled = false;
            };

            synth.speak(utterance);
        }

        /**
         * H√†m chuy·ªÉn ƒë·ªïi s·ªë (1-99) sang H√°n t·ª± v√† Pinyin.
         */
        function numberToChinese(num) {
            if (num < 1 || num > 99) return { char: 'Kh√¥ng r√µ', pinyin: 'B√π m√≠ng' };

            const tens = Math.floor(num / 10);
            const ones = num % 10;
            
            let char = '';
            let pinyin = '';

            if (num < 10) { 
                char = unitChar[num];
                pinyin = unitPinyin[num];
            } else if (num === 10) { 
                 char = tenChar;
                 pinyin = tenPinyin;
            } else if (num < 20) { 
                char = tenChar + unitChar[ones];
                pinyin = tenPinyin + ' ' + unitPinyin[ones];
            } else { 
                char = unitChar[tens] + tenChar;
                pinyin = unitPinyin[tens] + ' ' + tenPinyin;

                if (ones > 0) {
                    char += unitChar[ones];
                    pinyin += ' ' + unitPinyin[ones];
                }
            }
            
            return { char: char.trim(), pinyin: pinyin.trim() };
        }


        /**
         * H√†m t·∫°o ng·∫´u nhi√™n m·ªôt m·∫£ng c√°c s·ªë duy nh·∫•t.
         */
        function generateRandomNumbers(count, min, max) {
            const numbers = new Set();
            while (numbers.size < count) {
                const randomNumber = Math.floor(Math.random() * (max - min + 1)) + min;
                numbers.add(randomNumber);
            }
            return Array.from(numbers);
        }

        /**
         * H√†m qu·∫£n l√Ω ch·∫ø ƒë·ªô S√°ng/T·ªëi.
         */
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            document.getElementById('sun-icon').classList.toggle('hidden', isDarkMode);
            document.getElementById('moon-icon').classList.toggle('hidden', !isDarkMode);
        }

        /**
         * X·ª≠ l√Ω s·ª± ki·ªán khi h·ªçc sinh click v√†o m·ªôt s·ªë.
         */
        function handleNumberClick(event) {
            const circle = event.currentTarget;
            const number = parseInt(circle.getAttribute('data-number'), 10);
            
            if (circle.classList.contains('correct-flash') || circle.classList.contains('incorrect-flash') || circle.classList.contains('hidden-circle') || !isGameActive) {
                return;
            }

            if (currentSelected && currentSelected !== circle) {
                // ƒê·∫£m b·∫£o lo·∫°i b·ªè c√°c class "selected" v√† flash tr∆∞·ªõc khi th√™m l·∫°i
                currentSelected.classList.remove('selected', 'bg-red-500', 'text-white', 'correct-flash', 'incorrect-flash', 'bg-green-500');
                currentSelected.classList.add('bg-blue-500', 'dark:bg-blue-600');
                currentSelected.style.border = 'none';
            }
            
            currentSelected = circle;
            selectedNumberDisplay.textContent = number;
            feedbackMessage.classList.add('hidden'); 

            if (number === targetNumber) {
                synth.cancel();

                circle.classList.remove('bg-blue-500', 'dark:bg-blue-600');
                circle.classList.add('selected', 'bg-green-500', 'text-white', 'correct-flash');

                correctGuesses++;
                scoreDisplay.textContent = `ƒê√∫ng: ${correctGuesses}`;

                isGameActive = false;

                setTimeout(() => {
                    circle.classList.remove('correct-flash');
                    circle.classList.add('bg-green-500'); 
                    circle.style.border = '4px solid #047857'; 

                    numbersContainer.querySelectorAll('.number-circle').forEach(c => c.removeEventListener('click', handleNumberClick));
                    helpButton.disabled = true; 

                    startNextRound();
                }, 1300); 

            } else {
                circle.classList.remove('bg-blue-500', 'dark:bg-blue-600');
                circle.classList.add('selected', 'bg-red-500', 'text-white', 'incorrect-flash');
                
                setTimeout(() => {
                    circle.classList.remove('selected', 'bg-red-500', 'text-white', 'incorrect-flash');
                    circle.classList.add('bg-blue-500', 'dark:bg-blue-600');
                    currentSelected = null; 
                    selectedNumberDisplay.textContent = 'Ch∆∞a c√≥';
                }, 1300); 
            }
        }

        /**
         * H√†m x·ª≠ l√Ω tr·ª£ gi√∫p 50/50.
         */
        function handleFiftyFiftyHelp() {
            if (isHelpUsed || targetNumber === null || !isGameActive) {
                return;
            }

            const incorrectCircles = Array.from(numbersContainer.querySelectorAll('.number-circle'))
                .filter(circle => 
                    parseInt(circle.getAttribute('data-number'), 10) !== targetNumber &&
                    !circle.classList.contains('hidden-circle')
                );

            const numbersToRemoveCount = Math.floor(incorrectCircles.length / 2);
            
            if (numbersToRemoveCount < 1) {
                feedbackMessage.textContent = `Kh√¥ng c√≥ ƒë·ªß ƒë√°p √°n sai ƒë·ªÉ lo·∫°i b·ªè. H√£y th·ª≠ l·∫°i!`;
                feedbackMessage.className = 'mb-8 p-4 text-center rounded-lg bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 font-semibold text-xl';
                feedbackMessage.classList.remove('hidden');
                helpButton.disabled = true;
                isHelpUsed = true;
                return;
            }

            const circlesToKeep = [...incorrectCircles];
            const circlesToRemove = [];

            while (circlesToRemove.length < numbersToRemoveCount && circlesToKeep.length > 0) {
                const randomIndex = Math.floor(Math.random() * circlesToKeep.length);
                circlesToRemove.push(circlesToKeep.splice(randomIndex, 1)[0]);
            }
            
            circlesToRemove.forEach(circle => {
                circle.classList.add('hidden-circle');
                circle.removeEventListener('click', handleNumberClick); 
            });

            isHelpUsed = true;
            helpButton.disabled = true;
            helpButton.textContent = 'ƒê√£ d√πng (50/50)';
            
            feedbackMessage.classList.add('hidden');
        }

        /**
         * H√†m hi·ªÉn th·ªã Modal ch√∫c m·ª´ng v√† k·∫øt th√∫c tr√≤ ch∆°i.
         */
        function showGameOver(message = 'Ho√†n Th√†nh!') {
            // D·ª™NG ƒê·ªíNG H·ªí D√ô TH·∫ÆNG HAY THUA/H·∫æT GI·ªú
            stopTimer(); 

            isGameActive = false;
            generateButton.textContent = '‚ñ∂Ô∏è Ch∆°i l·∫°i'; 
            helpButton.disabled = true;
            speakButton.disabled = true;
            synth.cancel(); 

            finalScoreDisplay.textContent = `${correctGuesses}/${totalRounds}`;
            modalTotalRoundsDisplay.textContent = totalRounds; 

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ Modal v√† ph√°o gi·∫•y
            const modalTitle = document.getElementById('modal-title');
            if (message === 'H·∫øt gi·ªù!') {
                modalTitle.textContent = '‚è±Ô∏è H·∫øt Gi·ªù!';
                modalTitle.classList.remove('text-green-600', 'dark:text-green-400');
                modalTitle.classList.add('text-red-600', 'dark:text-red-400');
                // D·ª´ng ph√°o gi·∫•y n·∫øu h·∫øt gi·ªù
                stopConfetti(); 
            } else {
                 modalTitle.textContent = 'üéâ Ho√†n Th√†nh!';
                 modalTitle.classList.remove('text-red-600', 'dark:text-red-400');
                 modalTitle.classList.add('text-green-600', 'dark:text-green-400');
                 // B·∫Øn ph√°o gi·∫•y n·∫øu ho√†n th√†nh
                 startConfetti();
            }
            
            gameOverModal.classList.remove('hidden');
            gameOverModal.classList.add('flex');
        }

        /**
         * H√†m b·∫Øt ƒë·∫ßu v√≤ng ch∆°i m·ªõi (ho·∫∑c ki·ªÉm tra k·∫øt th√∫c game).
         */
        function startNextRound() {
            // KI·ªÇM TRA ƒê·ªÇ K·∫æT TH√öC GAME
            if (currentRound >= totalRounds) {
                // N·∫øu ho√†n th√†nh ƒë·ªß v√≤ng, g·ªçi showGameOver v·ªõi th√¥ng b√°o m·∫∑c ƒë·ªãnh
                showGameOver(); 
                return;
            }
            
            synth.cancel();
            
            currentRound++;
            isGameActive = true;
            isHelpUsed = false; 
            helpButton.disabled = false;
            speakButton.disabled = false;
            helpButton.textContent = 'üí° Tr·ª£ gi√∫p 50/50';

            roundDisplay.textContent = `V√≤ng: ${currentRound}/${totalRounds}`;
            generateButton.textContent = '‚ú® B·ªè qua/T·∫°o l·∫°i S·ªë M·ªõi'; 
            startPrompt.classList.add('hidden'); 
            
            numbersContainer.innerHTML = '';
            currentSelected = null;
            selectedNumberDisplay.textContent = 'Ch∆∞a c√≥';
            feedbackMessage.classList.add('hidden');

            let randomNumbers = generateRandomNumbers(count, min, max);

            let newTargetNumber = null;

            const availableGlobalNumbers = [];
            for (let i = min; i <= max; i++) {
                if (!usedTargetNumbers.has(i)) {
                    availableGlobalNumbers.push(i);
                }
            }

            if (availableGlobalNumbers.length === 0) {
                console.error("ƒê√£ s·ª≠ d·ª•ng h·∫øt t·∫•t c·∫£ c√°c s·ªë c√≥ th·ªÉ c√≥ (1-99). Game s·∫Ω k·∫øt th√∫c.");
                showGameOver();
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableGlobalNumbers.length);
            newTargetNumber = availableGlobalNumbers[randomIndex];

            if (!randomNumbers.includes(newTargetNumber)) {
                const replaceIndex = Math.floor(Math.random() * randomNumbers.length);
                randomNumbers[replaceIndex] = newTargetNumber;
                
                randomNumbers = randomNumbers.sort(() => Math.random() - 0.5);
            }
            
            targetNumber = newTargetNumber;
            usedTargetNumbers.add(targetNumber); 

            const chineseTarget = numberToChinese(targetNumber);

            targetChineseCharDisplay.textContent = `${chineseTarget.char}`;
            targetChinesePinyinDisplay.textContent = `(${chineseTarget.pinyin})`;

            speakChineseText(chineseTarget.char);


            randomNumbers.forEach(number => {
                const circle = document.createElement('div');
                // S·ª≠ d·ª•ng Tailwind: w-16 h-16 (64px) tr√™n mobile, w-20 h-20 (80px) tr√™n sm+
                // Text: text-xl (20px) tr√™n mobile, text-2xl (24px) tr√™n sm+
                circle.className = 'number-circle flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-blue-500 dark:bg-blue-600 text-white text-xl sm:text-2xl font-bold cursor-pointer';
                circle.setAttribute('data-number', number);
                circle.textContent = number;
                circle.addEventListener('click', handleNumberClick);

                numbersContainer.appendChild(circle);
            });
            
            console.log(`[DEBUG] V√≤ng ${currentRound}/${totalRounds}. M·ª•c Ti√™u: ${targetNumber} (${chineseTarget.char}). ƒê√£ d√πng ${usedTargetNumbers.size} s·ªë.`); 
        }

        /**
         * B·∫Øt ƒë·∫ßu m·ªôt game m·ªõi (reset t·∫•t c·∫£).
         */
        function restartGame() {
            stopConfetti();
            stopTimer(); // ƒê·∫£m b·∫£o timer c≈© ƒë√£ d·ª´ng

            totalRounds = parseInt(roundSelector.value, 10);

            if (totalRounds > max - min + 1) {
                console.error(`L·ªói: Kh√¥ng th·ªÉ ch·ªçn ${totalRounds} v√≤ng ch∆°i v√¨ ch·ªâ c√≥ ${max - min + 1} s·ªë t·ª´ 1 ƒë·∫øn 99.`);
                roundSelector.value = 5; 
                totalRounds = 5;
                
                remainingTime = totalRounds * TIME_PER_ROUND;
                updateTimerDisplay(); // C·∫≠p nh·∫≠t th·ªùi gian ban ƒë·∫ßu
                
                roundDisplay.textContent = `V√≤ng: 0/${totalRounds}`;
                startPrompt.textContent = `Nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i ${totalRounds} v√≤ng!`;
            }

            gameOverModal.classList.add('hidden');
            gameOverModal.classList.remove('flex');
            
            currentRound = 0;
            correctGuesses = 0;
            usedTargetNumbers.clear(); 
            isGameActive = true;
            
            // B·∫ÆT ƒê·∫¶U ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C
            startTimer(); 
            
            startNextRound();
        }

        /**
         * Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫£i trang.
         */
        function initializeGameOnLoad() {
            if (synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = loadChineseVoice;
            }
            loadChineseVoice(); 

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.body.classList.add('dark');
                document.getElementById('moon-icon').classList.remove('hidden');
                document.getElementById('sun-icon').classList.add('hidden');
            }
            
            totalRounds = parseInt(roundSelector.value, 10); 

            // T√≠nh to√°n v√† hi·ªÉn th·ªã th·ªùi gian ban ƒë·∫ßu
            remainingTime = totalRounds * TIME_PER_ROUND;
            updateTimerDisplay(); 

            currentRound = 0;
            correctGuesses = 0;
            isGameActive = false;
            isHelpUsed = false;
            stopConfetti(); 
            stopTimer(); // ƒê·∫£m b·∫£o kh√¥ng c√≥ timer ch·∫°y

            roundDisplay.textContent = `V√≤ng: 0/${totalRounds}`; 
            scoreDisplay.textContent = `ƒê√∫ng: 0`;
            generateButton.textContent = '‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i';
            helpButton.disabled = true;
            speakButton.disabled = true;
            gameOverModal.classList.add('hidden');
            numbersContainer.innerHTML = '';
            startPrompt.classList.remove('hidden');
            startPrompt.textContent = `Nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i ${totalRounds} v√≤ng!`; 
            targetChineseCharDisplay.textContent = '??'; 
            targetChinesePinyinDisplay.textContent = ''; 
            selectedNumberDisplay.textContent = 'Ch∆∞a c√≥';
            feedbackMessage.classList.add('hidden');

            // G√°n s·ª± ki·ªán cho c√°c n√∫t
            generateButton.addEventListener('click', restartGame);
            themeToggle.addEventListener('click', toggleTheme);
            helpButton.addEventListener('click', handleFiftyFiftyHelp);
            restartButtonModal.addEventListener('click', restartGame);
            speakButton.addEventListener('click', () => {
                const text = targetChineseCharDisplay.textContent;
                if (text && text !== '??') {
                    speakChineseText(text);
                }
            });

            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã V√≤ng v√† prompt b·∫Øt ƒë·∫ßu ngay khi ng∆∞·ªùi d√πng thay ƒë·ªïi s·ªë v√≤ng
            roundSelector.addEventListener('change', (e) => {
                const newTotalRounds = parseInt(e.target.value, 10);
                
                totalRounds = newTotalRounds; 
                
                // C·∫≠p nh·∫≠t th·ªùi gian hi·ªÉn th·ªã ch·ªù (tr·∫°ng th√°i 0/X)
                remainingTime = totalRounds * TIME_PER_ROUND;
                updateTimerDisplay();
                
                const currentRoundToDisplay = isGameActive ? currentRound : 0;
                roundDisplay.textContent = `V√≤ng: ${currentRoundToDisplay}/${totalRounds}`;
                
                if (!isGameActive) {
                    startPrompt.textContent = `Nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i ${totalRounds} v√≤ng!`;
                }
            });
        }

        // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        window.onload = initializeGameOnLoad;
    </script>
</body>
</html>
