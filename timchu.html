<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i T√¨m H√°n T·ª±</title>
    
    <!-- Google Fonts for Mulish -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- C·∫•u h√¨nh Tailwind CSS ƒë·ªÉ s·ª≠ d·ª•ng Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // B·∫≠t ch·∫ø ƒë·ªô t·ªëi b·∫±ng c√°ch th√™m class 'dark' v√†o body
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#2563EB',
                        'dark-bg': '#1f2937',
                        'dark-card': '#374151',
                        'theme-green': '#10b981',
                        'theme-red': '#ef4444',
                        'light-text': '#f9fafb', // gray-50
                    }
                }
            }
        }
    </script>
    <style>
        /* Thi·∫øt l·∫≠p font ch·ªØ Mulish cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Mulish', sans-serif;
            background-color: #f1f5f9;
            transition: background-color 0.3s;
        }

        /* √Åp d·ª•ng font Ê•∑‰Ωì (Kaiti) ho·∫∑c c√°c font th∆∞ ph√°p kh√°c cho H√°n t·ª± */
        .chinese-font {
            /* ƒê·∫£m b·∫£o H√°n t·ª± hi·ªÉn th·ªã r√µ r√†ng v√† ƒë·∫πp m·∫Øt */
            font-family: Ê•∑‰Ωì, 'KaiTi', 'SimSun', serif; 
        }
        
        /* Global Dark Mode Styles */
        .dark body {
            background-color: var(--dark-bg);
        }
        .dark .main-container {
            background-color: var(--dark-card);
        }
        .dark h1 {
            color: #93c5fd; /* blue-300 */
        }
        .dark p.text-gray-600 {
            color: #d1d5db; /* gray-300 */
        }

        /* ƒê·ªãnh nghƒ©a ki·ªÉu d√°ng cho c√°c √¥ t·ª´ v·ª±ng */
        .char-circle {
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Chuy·ªÉn ƒë·ªông m∆∞·ª£t m√† */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            user-select: none;
            will-change: transform, background-color, border-color; 
            width: 70px; /* w-24 */
            height: 55px; /* h-16 */
            font-size: 1.25rem; /* text-xl */
            
            /* CH·∫æ ƒê·ªò S√ÅNG M·∫∂C ƒê·ªäNH */
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border: 4px solid #3b82f6; /* Vi·ªÅn c√πng m√†u n·ªÅn */
        }
        
        /* ƒê·ªäNH NGHƒ®A RI√äNG CHO CH·∫æ ƒê·ªò T·ªêI (THEO Y√äU C·∫¶U) */
        .dark .char-circle {
            background-color: var(--dark-bg); /* N·ªÅn ch·ªØ H√°n gi·ªëng n·ªÅn body */
            color: white;
            border: 2px solid white; /* Vi·ªÅn m√†u tr·∫Øng */
        }
        
        @media (min-width: 640px) { /* sm breakpoint */
            .char-circle {
                width: 112px; /* sm:w-28 */
                height: 80px; /* sm:h-20 */
                font-size: 2.5rem; /* sm:text-2xl */
            }
        }

        /* Hover effect */
        .char-circle:hover:not(.correct-flash):not(.incorrect-flash):not(.hidden-circle) {
            transform: scale(1.05);
            /* B√≥ng ƒë·ªï cho ch·∫ø ƒë·ªô s√°ng */
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3), 0 4px 6px -4px rgba(37, 99, 235, 0.2);
        }
        .dark .char-circle:hover:not(.correct-flash):not(.incorrect-flash):not(.hidden-circle) {
            /* B√≥ng ƒë·ªï cho ch·∫ø ƒë·ªô t·ªëi (s·ª≠ d·ª•ng m√†u s√°ng h∆°n) */
            box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -4px rgba(255, 255, 255, 0.05);
        }
        
        /* Keyframe cho hi·ªáu ·ª©ng nh√°y XANH (ƒê√∫ng) */
        @keyframes flash-correct {
            0%, 100% { background-color: #10b981; border-color: #047857; transform: scale(1.1); }
            50% { background-color: #34d399; border-color: #059669; }
        }
        /* Keyframe cho hi·ªáu ·ª©ng nh√°y ƒê·ªé (Sai) */
        @keyframes flash-incorrect {
            0%, 100% { background-color: #ef4444; border-color: #b91c1c; transform: scale(1.1); }
            50% { background-color: #f87171; border-color: #dc2626; }
        }

        .char-circle.correct-flash {
            animation: flash-correct 0.4s 3; /* Nh√°y 3 l·∫ßn */
            pointer-events: none; /* Kh√¥ng cho click khi ƒëang flash */
        }
        .char-circle.incorrect-flash {
            animation: flash-incorrect 0.4s 3; /* Nh√°y 3 l·∫ßn */
            pointer-events: none;
        }

        /* Hi·ªáu ·ª©ng m·ªù d·∫ßn cho c√°c ch·ªØ H√°n b·ªã lo·∫°i b·ªè */
        .char-circle.hidden-circle {
            opacity: 0;
            transform: scale(0.5);
            pointer-events: none;
        }
        
        /* ƒê·∫£m b·∫£o canvas ph√°o gi·∫•y n·∫±m sau modal content */
        #game-over-modal {
            position: fixed; 
            overflow: hidden;
        }
        #fireworks-canvas {
            z-index: 5; 
        }
    </style>
</head>
<body class="p-0 sm:p-8 min-h-screen flex flex-col items-center">

    <!-- Container ch√≠nh -->
    <div class="main-container max-w-full sm:max-w-4xl w-full bg-white dark:bg-dark-card p-4 sm:p-10 rounded-none sm:rounded-xl shadow-2xl transition-colors">
        
        <!-- Header v√† N√∫t chuy·ªÉn ƒë·ªïi giao di·ªán S√°ng/T·ªëi -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700 dark:text-blue-300">
                üìö T√¨m H√°n T·ª±
            </h1>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-colors shadow-md hover:shadow-lg">
                <!-- Icon M·∫∑t Tr·ªùi (S√°ng) -->
                <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <!-- Icon M·∫∑t TrƒÉng (T·ªëi) -->
                <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
        
        <!-- √î ch·ªçn B√ÄI H·ªåC (Ph·∫ßn ch·ªçn v√≤ng ch∆°i ƒë√£ ƒë∆∞·ª£c lo·∫°i b·ªè) -->
        <div class="mb-4 flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-4">
            <!-- Dropdown ch·ªçn B√†i h·ªçc -->
            <label for="lesson-selector" class="text-gray-700 dark:text-gray-300 font-semibold">Ch·ªçn B√†i h·ªçc:</label>
            <select id="lesson-selector" class="p-2 rounded-lg border-2 border-primary-blue bg-white dark:bg-gray-700 dark:text-white font-bold transition-colors shadow-sm focus:ring-2 focus:ring-primary-blue mr-4">
                <!-- C√°c option n√†y s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t trong th·ª±c t·∫ø -->
                <option value="bai1">B√†i 1 ËÄÅÂ∏àÊÇ®Â•Ω</option>
            </select>
            
            <!-- Hidden Round Selector (Gi·ªØ l·∫°i ƒë·ªÉ logic JS kh√¥ng b·ªã l·ªói, nh∆∞ng b·ªã ·∫©n) -->
            <select id="round-selector" class="hidden">
                <option value="10">10 V√≤ng (M·∫∑c ƒë·ªãnh)</option>
            </select>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã V√≤ng, TH·ªúI GIAN v√† ƒêi·ªÉm s·ªë -->
        <div class="flex justify-between items-center text-xl font-bold mb-6 p-3 rounded-lg bg-gray-100 dark:bg-gray-800 shadow-inner">
            <span id="round-display" class="text-gray-700 dark:text-gray-300 text-base sm:text-xl">V√≤ng: 0/10</span>
            <span id="timer-display" class="text-2xl sm:text-3xl tracking-wider text-theme-red dark:text-red-400 font-extrabold">01:20s</span> 
            <span id="score-display" class="text-theme-green dark:text-green-400 text-base sm:text-xl">ƒê√∫ng: 0</span>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã M·ª§C TI√äU (√ù NGHƒ®A v√† PINYIN) -->
        <div class="text-center mb-8 p-4 rounded-xl bg-blue-500 dark:bg-blue-700 shadow-xl">
            <!-- D√≤ng "T·ª´ v·ª±ng b·∫°n c·∫ßn t√¨m c√≥ nghƒ©a l√†:" ƒë√£ ƒë∆∞·ª£c lo·∫°i b·ªè -->
            <div id="target-chinese-display" class="text-white text-2xl font-medium">
                <!-- √ù nghƒ©a (Meaning) -->
                <p id="target-chinese-meaning" class="text-yellow-200 font-extrabold text-2xl sm:text-3xl tracking-wider px-2">Nh·∫•n B·∫Øt ƒë·∫ßu</p>
                <!-- Pinyin -->
                <p id="target-chinese-pinyin" class="text-yellow-100 italic text-base sm:text-xl mt-1"></p>
                <!-- N√∫t Nghe l·∫°i (ƒê·ªçc H√°n t·ª±) -->
                <button id="speak-button" class="mt-3 px-3 py-1 bg-blue-700 hover:bg-blue-800 text-white text-sm font-semibold rounded-full disabled:opacity-50" disabled>
                    <svg class="w-4 h-4 inline-block align-text-bottom" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-4l-4 4v-4H9a1 1 0 01-1-1v-5a1 1 0 011-1h2l3-3 3 3h2zM7 7H5a1 1 0 00-1 1v2a1 1 0 001 1h2v-4z" clip-rule="evenodd"></path></svg>
                    Nghe ph√°t √¢m
                </button>
                <audio id="audio-player" class="hidden"></audio>
            </div>
        </div>

        <!-- Khu v·ª±c hi·ªÉn th·ªã th√¥ng b√°o k·∫øt qu·∫£ -->
        <div id="feedback-message" class="mb-8 p-4 text-center rounded-lg font-semibold text-xl border-l-4 hidden">
            <!-- N·ªôi dung ph·∫£n h·ªìi s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS -->
        </div>
        
        <!-- Khu v·ª±c hi·ªÉn th·ªã ch·ªØ H√°n ƒë√£ ch·ªçn/ch·ªù ch·ªçn -->
        <div class="mb-8 p-4 text-center rounded-lg bg-yellow-50 dark:bg-yellow-900/50 border-l-4 border-yellow-500 dark:border-yellow-400 text-yellow-800 dark:text-yellow-200 font-semibold text-base sm:text-xl">
            B·∫°n ƒë√£ ch·ªçn: <span id="selected-char" class="text-blue-600 dark:text-blue-300 font-bold chinese-font">Ch∆∞a c√≥</span>
        </div>

        <!-- Khu v·ª±c ch·ª©a 10 ch·ªØ H√°n ƒë·ªÉ ch·ªçn (Responsive Layout: 4 c·ªôt tr√™n mobile, 5 c·ªôt tr√™n tablet+) -->
        <div id="chars-container" class="w-full mx-auto border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 grid grid-cols-4 md:grid-cols-5 gap-3 sm:gap-4 justify-items-center items-center relative" style="min-height: 250px;">
            <p id="start-prompt" class="absolute inset-0 flex items-center justify-center text-lg sm:text-xl text-gray-500 dark:text-gray-400 col-span-5">
                Ch·ªçn B√†i h·ªçc v√† nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ b·∫Øt ƒë·∫ßu!
            </p>
            <!-- C√°c h√¨nh tr√≤n ch·ªØ H√°n s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript t·∫°i ƒë√¢y -->
        </div>

        <!-- N√∫t t·∫°o l·∫°i s·ªë v√† N√∫t Tr·ª£ gi√∫p (Responsive stacking) -->
        <div class="flex flex-col sm:flex-row justify-center mt-10 space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="help-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition-all active:scale-95 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                üí° Tr·ª£ gi√∫p 50/50
            </button>
            <button id="generate-button" class="px-6 py-3 bg-primary-blue text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all active:scale-95 text-lg">
                ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i
            </button>
        </div>
    </div>

    <!-- MODAL HI·ªÇN TH·ªä K·∫æT QU·∫¢ CU·ªêI C√ôNG -->
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <!-- Canvas cho hi·ªáu ·ª©ng ph√°o gi·∫•y -->
        <canvas id="fireworks-canvas" class="absolute inset-0 w-full h-full"></canvas>

        <div class="bg-white dark:bg-gray-700 p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-all scale-100 relative z-10">
            <h2 id="modal-title" class="text-4xl font-extrabold text-theme-green dark:text-green-400 mb-4">üéâ Ho√†n Th√†nh!</h2>
            <p class="text-lg text-gray-700 dark:text-gray-200 mb-6">B·∫°n ƒë√£ ho√†n th√†nh <span id="modal-total-rounds">10</span> v√≤ng ch∆°i.</p>
            <p class="text-2xl font-semibold text-gray-800 dark:text-white mb-8">K·∫øt qu·∫£ cu·ªëi c√πng: <span id="final-score" class="text-blue-600 dark:text-blue-400 font-extrabold">0/10</span></p>
            <button id="restart-button-modal" class="px-6 py-3 bg-primary-blue text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all active:scale-95 text-lg">
                Ch∆°i l·∫°i
            </button>
        </div>
    </div>

    <script>
        // --- D·ªÆ LI·ªÜU GI·∫¢ L·∫¨P ---
        // D·ªØ li·ªáu gi·∫£ l·∫≠p cho c√°c b√†i h·ªçc. Trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø, d·ªØ li·ªáu n√†y s·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ c√°c file .txt.
        const FAKE_LESSON_DATA = {
            'bai1': [
                { char: '‰Ω†', pinyin: 'n«ê', meaning: 'b·∫°n, c·∫≠u' },
                { char: 'Êàë', pinyin: 'w«í', meaning: 't√¥i' },
                { char: 'ÊÇ®', pinyin: 'n√≠n', meaning: 'ng√†i (l·ªãch s·ª±)' },
                { char: 'ËÄÅÂ∏à', pinyin: 'l«éoshƒ´', meaning: 'th·∫ßy/c√¥ gi√°o' },
                { char: 'Â≠¶Áîü', pinyin: 'xu√©sheng', meaning: 'h·ªçc sinh' },
                { char: 'Â•Ω', pinyin: 'h«éo', meaning: 't·ªët, kh·ªèe' },
                { char: 'Âæà', pinyin: 'hƒõn', meaning: 'r·∫•t' },
                { char: 'Âêó', pinyin: 'ma', meaning: 'kh√¥ng (tr·ª£ t·ª´ nghi v·∫•n)' },
                { char: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', meaning: 'c·∫£m ∆°n' },
                { char: 'Ëøô', pinyin: 'zh√®', meaning: 'n√†y, ƒë√¢y' },
                { char: 'ÈÇ£', pinyin: 'n√†', meaning: 'kia, ƒë√≥' },
                { char: 'ÊòØ', pinyin: 'sh√¨', meaning: 'l√†' },
                { char: '‰∏ç', pinyin: 'b√π', meaning: 'kh√¥ng (ph·ªß ƒë·ªãnh)' },
                { char: 'Êú¨Â≠ê', pinyin: 'bƒõnzi', meaning: 'v·ªü' },
                { char: '‰π¶', pinyin: 'sh≈´', meaning: 's√°ch' },
                { char: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', meaning: 'xin ch√†o' },
                { char: 'ÂÜçËßÅ', pinyin: 'z√†iji√†n', meaning: 't·∫°m bi·ªát' },
                { char: 'ÈôàÊ•†', pinyin: 'Ch√©n N√°n', meaning: 'Tr·∫ßn Nam' },
                { char: 'ÂõΩÂÆâ', pinyin: 'Gu√≥‚ÄôƒÅn', meaning: 'Qu·ªëc An' },
            ],
            'bai2': [
                { char: 'ÂÆ∂', pinyin: 'jiƒÅ', meaning: 'nh√†, gia ƒë√¨nh' },
                { char: '‰∫∫', pinyin: 'r√©n', meaning: 'ng∆∞·ªùi' },
                { char: 'Êúâ', pinyin: 'y«íu', meaning: 'c√≥' },
                { char: 'Âá†', pinyin: 'j«ê', meaning: 'm·∫•y, v√†i' },
                { char: '‰∏™', pinyin: 'g√®', meaning: 'c√°i, chi·∫øc' },
                { char: 'Áà∏Áà∏', pinyin: 'b√†ba', meaning: 'b·ªë' },
                { char: 'Â¶àÂ¶à', pinyin: 'mƒÅma', meaning: 'm·∫π' },
                { char: 'Âì•Âì•', pinyin: 'gƒìge', meaning: 'anh trai' },
                { char: 'ÂßêÂßê', pinyin: 'jiƒõjie', meaning: 'ch·ªã g√°i' },
                { char: 'ÂºüÂºü', pinyin: 'd√¨di', meaning: 'em trai' },
                { char: 'Â¶πÂ¶π', pinyin: 'm√®imei', meaning: 'em g√°i' },
                { char: 'Âíå', pinyin: 'h√©', meaning: 'v√†' },
                { char: 'ÈÉΩ', pinyin: 'd≈çu', meaning: 'ƒë·ªÅu' },
                { char: 'Â∑•‰Ωú', pinyin: 'g≈çngzu√≤', meaning: 'c√¥ng vi·ªác, l√†m vi·ªác' },
                { char: 'ÂåªÁîü', pinyin: 'yƒ´shƒìng', meaning: 'b√°c sƒ©' },
                { char: 'Áà±', pinyin: '√†i', meaning: 'y√™u' },
            ],
            // D·ªØ li·ªáu Bai 3 ƒë√£ ƒë∆∞·ª£c s·ª≠a l·ªói c√∫ ph√°p.
            'bai3': [
                { char: 'ÂêÉ', pinyin: 'chƒ´', meaning: 'ƒÉn' },
                { char: 'È•≠', pinyin: 'f√†n', meaning: 'c∆°m' },
                { char: 'Ëèú', pinyin: 'c√†i', meaning: 'rau, m√≥n ƒÉn' },
                { char: 'Á±≥È•≠', pinyin: 'm«êf√†n', meaning: 'c∆°m tr·∫Øng' },
                { char: 'Èù¢Êù°', pinyin: 'mi√†nti√°o', meaning: 'm√¨ s·ª£i' },
                { char: 'Âñù', pinyin: 'hƒì', meaning: 'u·ªëng' }, // <-- L·ªói c√∫ ph√°p ƒë√£ ƒë∆∞·ª£c s·ª≠a ·ªü ƒë√¢y
                { char: '·ªßy', pinyin: 'shu«ê', meaning: 'n∆∞·ªõc' },
                { char: 'Ëå∂', pinyin: 'ch√°', meaning: 'tr√†' },
                { char: 'ÂíñÂï°', pinyin: 'kƒÅfƒìi', meaning: 'c√† ph√™' },
                { char: 'ÁâõÂ•∂', pinyin: 'ni√∫n«éi', meaning: 's·ªØa b√≤' },
            ],
            'bai4': [
                { char: 'Âéª', pinyin: 'q√π', meaning: 'ƒëi' },
                { char: 'Âì™ÂÑø', pinyin: 'n«ér', meaning: '·ªü ƒë√¢u' },
                { char: 'Â≠¶Ê†°', pinyin: 'xu√©xi√†o', meaning: 'tr∆∞·ªùng h·ªçc' },
                { char: 'ÂúñÊõ∏È§®', pinyin: 't√∫sh≈´gu«én', meaning: 'th∆∞ vi·ªán' },
                { char: 'ÂïÜÂ∫ó', pinyin: 'shƒÅngdi√†n', meaning: 'c·ª≠a h√†ng' },
                { char: '‰π∞', pinyin: 'm«éi', meaning: 'mua' },
                { char: '‰∏úË•ø', pinyin: 'd≈çngxi', meaning: 'ƒë·ªì ƒë·∫°c, th·ª©' },
                { char: 'Â§öÂ∞ë', pinyin: 'du≈çshao', meaning: 'bao nhi√™u' },
                { char: 'Èí±', pinyin: 'qi√°n', meaning: 'ti·ªÅn' },
                { char: 'Âùó', pinyin: 'ku√†i', meaning: 'ƒë·ªìng (ƒë∆°n v·ªã ti·ªÅn t·ªá)' },
            ]
        };

        // H√†m gi·∫£ l·∫≠p t·∫£i d·ªØ li·ªáu t·ª´ file baiX.txt
        async function fetchLessonData(lessonId) {
            // Trong m√¥i tr∆∞·ªùng th·ª±c t·∫ø, b·∫°n s·∫Ω d√πng fetch:
            // const response = await fetch(`data_findword/${lessonId}/${lessonId}.txt`);
            // const text = await response.text();
            // CHUY·ªÇN D·ªÆ LI·ªÜU TEXT TH√ÄNH M·∫¢NG OBJECT V√Ä TR·∫¢ V·ªÄ

            // ·ªû ƒë√¢y, ch√∫ng ta d√πng d·ªØ li·ªáu gi·∫£ l·∫≠p:
            return new Promise((resolve, reject) => {
                if (FAKE_LESSON_DATA[lessonId]) {
                    // Gi·∫£ l·∫≠p ƒë·ªô tr·ªÖ m·∫°ng
                    setTimeout(() => resolve(FAKE_LESSON_DATA[lessonId]), 200); 
                } else {
                    reject(new Error(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho ${lessonId}`));
                }
            });
        }
        
        // C·∫•u h√¨nh ƒë∆∞·ªùng d·∫´n MP3
        function getAudioPath(lessonId, chineseChar) {
            // ƒê∆∞·ªùng d·∫´n th·ª±c t·∫ø theo c·∫•u tr√∫c b·∫°n cung c·∫•p:
            const baseChar = chineseChar.replace(/\s+/g, ''); // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng trong t·ª´ v·ª±ng
            return `data_findword/${lessonId}/mp3/${baseChar}.mp3`;
        }
        
        // --- C√ÅC BI·∫æN TO√ÄN C·ª§C ---
        const OPTIONS_COUNT = 10; 
        const DEFAULT_ROUNDS = 10; // M·∫∑c ƒë·ªãnh 10 v√≤ng ch∆°i
        let CHINESE_CHARACTERS = []; // D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y
        let MAX_ROUNDS = 0; 
        
        // DOM Elements
        const charsContainer = document.getElementById('chars-container');
        const selectedCharDisplay = document.getElementById('selected-char');
        const feedbackMessage = document.getElementById('feedback-message');
        const generateButton = document.getElementById('generate-button');
        const helpButton = document.getElementById('help-button');
        const themeToggle = document.getElementById('theme-toggle');
        const targetChineseMeaningDisplay = document.getElementById('target-chinese-meaning');
        const targetChinesePinyinDisplay = document.getElementById('target-chinese-pinyin');
        const startPrompt = document.getElementById('start-prompt');
        const speakButton = document.getElementById('speak-button');
        const roundSelector = document.getElementById('round-selector');
        const lessonSelector = document.getElementById('lesson-selector');
        // const maxRoundsInfo = document.getElementById('max-rounds-info'); // ƒê√£ lo·∫°i b·ªè
        const audioPlayer = document.getElementById('audio-player');
        
        // Game State Variables
        let totalRounds = DEFAULT_ROUNDS; // M·∫∑c ƒë·ªãnh l√† 10
        let currentRound = 0;
        let correctGuesses = 0;
        let isGameActive = false;
        let isHelpUsed = false;
        const usedTargetIndexes = new Set(); 
        
        // UI Elements for Game State
        const roundDisplay = document.getElementById('round-display');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display'); 
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButtonModal = document.getElementById('restart-button-modal');
        const modalTotalRoundsDisplay = document.getElementById('modal-total-rounds'); 

        let targetCharObject = null;
        let currentSelected = null;
        let isDarkMode = false;
        
        // Timer Variables
        const TIME_PER_ROUND = 8; 
        let remainingTime = 0;
        let timerInterval = null;
        
        // --- CONFETTI (PH√ÅO GI·∫§Y) VARIABLES (Gi·ªØ nguy√™n) ---
        const confettiCanvas = document.getElementById('fireworks-canvas'); 
        const ctx = confettiCanvas.getContext('2d');
        let particles = [];
        let animationFrameId = null; 
        let confettiBurstCount = 0;
        const maxConfettiBursts = 6; 
        const CONFETTI_COLORS = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#ffeb3b', '#ffc107', '#ff9800'];

        class ConfettiParticle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.width = Math.random() * 8 + 6; 
                this.height = Math.random() * 4 + 3;
                this.velocity = {
                    x: (Math.random() - 0.5) * 15, 
                    y: (Math.random() * -15) - 5 
                };
                this.gravity = 0.5; 
                this.alpha = 1;
                this.rotation = Math.random() * 360; 
                this.rotationSpeed = Math.random() * 0.1 + 0.05; 
                this.spin = Math.random() < 0.5 ? 1 : -1; 
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation * Math.PI / 180);
                ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
                ctx.restore();
            }

            update() {
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.velocity.x *= 0.98;
                this.rotation += this.rotationSpeed * this.spin * 10;
                if (this.y > confettiCanvas.height * 1.5) {
                    this.alpha = 0; 
                } else if (this.y > confettiCanvas.height * 0.8) {
                    this.alpha -= 0.008;
                }
                this.draw();
            }
        }

        function createConfettiBurst(x, y, count = 100) {
            for (let i = 0; i < count; i++) {
                const color = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
                particles.push(new ConfettiParticle(x, y, color));
            }
        }

        function animateConfetti() {
            animationFrameId = requestAnimationFrame(animateConfetti);
            
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            particles.forEach((particle, index) => {
                if (particle.alpha <= 0) {
                    particles.splice(index, 1);
                } else {
                    particle.update();
                }
            });

            if (confettiBurstCount < maxConfettiBursts && Math.random() < 0.1) { 
                const x = Math.random() * confettiCanvas.width;
                const y = confettiCanvas.height * 0.1; 
                createConfettiBurst(x, y, 70); 
                confettiBurstCount++; 
            }
            
            if (confettiBurstCount >= maxConfettiBursts && particles.length === 0) {
                 stopConfetti();
                 return;
            }

            if (particles.length > 500) {
                particles = particles.slice(particles.length - 500);
            }
        }

        function startConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            
            if (!animationFrameId) {
                particles = []; 
                confettiBurstCount = 0; 
                animateConfetti();
            }
        }

        function stopConfetti() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                particles = [];
            }
        }
        window.addEventListener('resize', () => {
            if (animationFrameId) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        });
        // --- END CONFETTI VARIABLES ---
        
        /**
         * D·ª´ng ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c.
         */
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.classList.remove('animate-pulse', 'text-red-500'); 
            }
        }

        /**
         * C·∫≠p nh·∫≠t hi·ªÉn th·ªã ƒë·ªìng h·ªì.
         */
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}s`;
            timerDisplay.textContent = `${timeString}`;
            
            if (remainingTime <= 10 && remainingTime > 0) {
                 timerDisplay.classList.add('animate-pulse', 'text-theme-red');
            } else {
                 timerDisplay.classList.remove('animate-pulse', 'text-theme-red');
            }
        }
        
        /**
         * B·∫Øt ƒë·∫ßu ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c.
         */
        function startTimer() {
            stopTimer(); 
            
            remainingTime = totalRounds * TIME_PER_ROUND;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    stopTimer();
                    isGameActive = false;
                    showGameOver('H·∫øt gi·ªù!');
                }
            }, 1000);
        }

        /**
         * H√†m ph√°t √¢m thanh t·ª´ file MP3.
         */
        function speakChineseTextFromMP3(chineseChar) {
            const lessonId = lessonSelector.value;
            const audioPath = getAudioPath(lessonId, chineseChar);
            
            audioPlayer.src = audioPath;
            speakButton.disabled = true;

            audioPlayer.onerror = () => {
                console.error(`Kh√¥ng th·ªÉ t·∫£i file √¢m thanh: ${audioPath}. S·ª≠ d·ª•ng TTS thay th·∫ø.`);
                speakChineseTextFallback(chineseChar);
            };

            audioPlayer.oncanplay = () => {
                audioPlayer.play();
            };
            
            audioPlayer.onended = () => {
                 speakButton.disabled = false;
            }
        }
        
        /**
         * H√†m ph√°t √¢m d·ª± ph√≤ng (s·ª≠ d·ª•ng Web Speech API)
         */
        function speakChineseTextFallback(text) {
             const synth = window.speechSynthesis;
             if (!synth) {
                 console.error("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.");
                 return;
             }

             synth.cancel();

             const utterance = new SpeechSynthesisUtterance(text);
             utterance.lang = 'zh-CN'; 
             utterance.rate = 0.8; 
            
             utterance.onend = () => {
                 speakButton.disabled = false;
             };
             
             speakButton.disabled = true;
             synth.speak(utterance);
        }

        /**
         * H√†m t·∫°o ng·∫´u nhi√™n m·ªôt m·∫£ng c√°c T·ª´ V·ª±ng duy nh·∫•t (bao g·ªìm c·∫£ m·ª•c ti√™u).
         */
        function generateRandomCharacters() {
            const currentData = CHINESE_CHARACTERS;
            
            const availableIndexes = [];
            for (let i = 0; i < currentData.length; i++) {
                if (!usedTargetIndexes.has(i)) {
                    availableIndexes.push(i);
                }
            }

            if (availableIndexes.length === 0 || currentData.length < OPTIONS_COUNT) {
                return { options: [], target: null };
            }
            
            // 1. Ch·ªçn m·ª•c ti√™u ng·∫´u nhi√™n t·ª´ c√°c index ch∆∞a d√πng
            const targetIndex = availableIndexes[Math.floor(Math.random() * availableIndexes.length)];
            const newTargetCharObject = currentData[targetIndex];

            // Th√™m m·ª•c ti√™u v√†o danh s√°ch ƒë√£ d√πng
            usedTargetIndexes.add(targetIndex); 

            let distractors = [];
            let allOptions = [];
            
            // L·∫•y t·∫•t c·∫£ c√°c T·ª´ V·ª±ng ngo·∫°i tr·ª´ m·ª•c ti√™u
            const pool = currentData.filter((_, index) => index !== targetIndex);
            
            // 2. L·∫•y 9 distractors ng·∫´u nhi√™n t·ª´ pool (ƒë·∫£m b·∫£o kh√¥ng tr√πng)
            const shuffledPool = pool.sort(() => Math.random() - 0.5);
            distractors = shuffledPool.slice(0, OPTIONS_COUNT - 1);
            
            // 3. K·∫øt h·ª£p m·ª•c ti√™u v√† distractors, sau ƒë√≥ x√°o tr·ªôn
            allOptions = [...distractors, newTargetCharObject].sort(() => Math.random() - 0.5);

            return { 
                options: allOptions, 
                target: newTargetCharObject 
            };
        }

        /**
         * H√†m qu·∫£n l√Ω ch·∫ø ƒë·ªô S√°ng/T·ªëi.
         */
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            document.getElementById('sun-icon').classList.toggle('hidden', isDarkMode);
            document.getElementById('moon-icon').classList.toggle('hidden', !isDarkMode);
        }

        /**
         * X·ª≠ l√Ω s·ª± ki·ªán khi ng∆∞·ªùi d√πng click v√†o m·ªôt t·ª´ v·ª±ng.
         */
        function handleCharClick(event) {
            const circle = event.currentTarget;
            const selectedChar = circle.getAttribute('data-char');
            
            if (!isGameActive || circle.classList.contains('correct-flash') || circle.classList.contains('incorrect-flash') || circle.classList.contains('hidden-circle')) {
                return;
            }
            
            if (currentSelected && currentSelected !== circle) {
                // ƒê·∫£m b·∫£o lo·∫°i b·ªè l·ªõp 'selected' khi ch·ªçn √¥ m·ªõi v√† kh√¥i ph·ª•c v·ªÅ tr·∫°ng th√°i CSS
                currentSelected.classList.remove('selected', 'bg-theme-red', 'text-white', 'correct-flash', 'incorrect-flash', 'bg-theme-green');
                currentSelected.classList.remove('font-bold'); 
                currentSelected.classList.add('font-medium');
                // Lo·∫°i b·ªè border inline n·∫øu c√≥
                currentSelected.style.border = ''; 
            }
            
            currentSelected = circle;
            selectedCharDisplay.textContent = selectedChar;
            feedbackMessage.classList.add('hidden'); 

            if (selectedChar === targetCharObject.char) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                
                // Khi ƒë√∫ng, ch·ªâ th√™m c√°c l·ªõp li√™n quan ƒë·∫øn flash v√† font-bold
                circle.classList.remove('font-medium');
                circle.classList.add('selected', 'bg-theme-green', 'text-white', 'correct-flash', 'font-bold'); 
                // Ghi ƒë√® m√†u n·ªÅn v√† vi·ªÅn cho hi·ªáu ·ª©ng flash
                circle.style.border = '4px solid #047857'; // border dark green

                correctGuesses++;
                scoreDisplay.textContent = `ƒê√∫ng: ${correctGuesses}`;

                isGameActive = false;

                setTimeout(() => {
                    circle.classList.remove('correct-flash');
                    circle.classList.add('bg-theme-green'); 
                    circle.style.border = '4px solid #047857'; // Gi·ªØ l·∫°i border sau flash

                    charsContainer.querySelectorAll('.char-circle').forEach(c => c.removeEventListener('click', handleCharClick));
                    helpButton.disabled = true; 

                    startNextRound();
                }, 1300); 

            } else {
                // Khi sai
                circle.classList.remove('font-medium');
                circle.classList.add('selected', 'bg-theme-red', 'text-white', 'incorrect-flash', 'font-bold');
                circle.style.border = '4px solid #b91c1c'; // border dark red
                
                setTimeout(() => {
                    // Kh√¥i ph·ª•c v·ªÅ tr·∫°ng th√°i CSS ban ƒë·∫ßu (ƒë·ªÉ CSS Dark Mode c√≥ hi·ªáu l·ª±c)
                    circle.classList.remove('selected', 'bg-theme-red', 'text-white', 'incorrect-flash', 'font-bold');
                    circle.classList.add('font-medium');
                    circle.style.border = ''; // Lo·∫°i b·ªè border inline
                    currentSelected = null; 
                    selectedCharDisplay.textContent = 'Ch∆∞a c√≥';
                }, 1300); 
            }
        }

        /**
         * H√†m x·ª≠ l√Ω tr·ª£ gi√∫p 50/50.
         */
        function handleFiftyFiftyHelp() {
            if (isHelpUsed || targetCharObject === null || !isGameActive) {
                return;
            }

            const incorrectCircles = Array.from(charsContainer.querySelectorAll('.char-circle'))
                .filter(circle => 
                    circle.getAttribute('data-char') !== targetCharObject.char &&
                    !circle.classList.contains('hidden-circle')
                );

            const charsToRemoveCount = Math.floor(incorrectCircles.length / 2);
            
            if (charsToRemoveCount < 1) {
                feedbackMessage.textContent = `Kh√¥ng c√≥ ƒë·ªß ƒë√°p √°n sai ƒë·ªÉ lo·∫°i b·ªè. H√£y t·ª± tin ch·ªçn!`;
                feedbackMessage.className = 'mb-8 p-4 text-center rounded-lg bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 font-semibold text-xl';
                feedbackMessage.classList.remove('hidden');
                helpButton.disabled = true;
                isHelpUsed = true;
                return;
            }

            const circlesToKeep = [...incorrectCircles];
            const circlesToRemove = [];

            while (circlesToRemove.length < charsToRemoveCount && circlesToKeep.length > 0) {
                const randomIndex = Math.floor(Math.random() * circlesToKeep.length);
                circlesToRemove.push(circlesToKeep.splice(randomIndex, 1)[0]);
            }
            
            circlesToRemove.forEach(circle => {
                circle.classList.add('hidden-circle');
                circle.removeEventListener('click', handleCharClick); 
            });

            isHelpUsed = true;
            helpButton.disabled = true;
            helpButton.textContent = 'ƒê√£ d√πng (50/50)';
            
            feedbackMessage.classList.add('hidden');
        }

        /**
         * H√†m hi·ªÉn th·ªã Modal ch√∫c m·ª´ng v√† k·∫øt th√∫c tr√≤ ch∆°i.
         */
        function showGameOver(message = 'Ho√†n Th√†nh!') {
            stopTimer(); 
            audioPlayer.pause();
            audioPlayer.currentTime = 0;

            isGameActive = false;
            generateButton.textContent = '‚ñ∂Ô∏è Ch∆°i l·∫°i'; 
            helpButton.disabled = true;
            speakButton.disabled = true;

            finalScoreDisplay.textContent = `${correctGuesses}/${totalRounds}`;
            modalTotalRoundsDisplay.textContent = totalRounds; 

            const modalTitle = document.getElementById('modal-title');
            if (message === 'H·∫øt gi·ªù!') {
                modalTitle.textContent = '‚è±Ô∏è H·∫øt Gi·ªù!';
                modalTitle.classList.remove('text-theme-green', 'dark:text-green-400');
                modalTitle.classList.add('text-theme-red', 'dark:text-red-400');
                stopConfetti(); 
            } else {
                 modalTitle.textContent = 'üéâ Ho√†n Th√†nh!';
                 modalTitle.classList.remove('text-theme-red', 'dark:text-red-400');
                 modalTitle.classList.add('text-theme-green', 'dark:text-green-400');
                 startConfetti();
            }
            
            gameOverModal.classList.remove('hidden');
            gameOverModal.classList.add('flex');
        }

        /**
         * H√†m b·∫Øt ƒë·∫ßu v√≤ng ch∆°i m·ªõi (ho·∫∑c ki·ªÉm tra k·∫øt th√∫c game).
         */
        function startNextRound() {
            if (currentRound >= totalRounds) {
                showGameOver(); 
                return;
            }
            
            const charData = generateRandomCharacters();

            // Ki·ªÉm tra xem c√≤n ƒë·ªß t·ª´ v·ª±ng ƒë·ªÉ t·∫°o v√≤ng ch∆°i hay kh√¥ng
            if (usedTargetIndexes.size >= CHINESE_CHARACTERS.length || charData.target === null) {
                // N·∫øu ƒë√£ d√πng h·∫øt ho·∫∑c kh√¥ng ƒë·ªß t·ª´ v·ª±ng cho v√≤ng ch∆°i
                if (usedTargetIndexes.size > 0) {
                     showGameOver('B·ªô t·ª´ v·ª±ng ƒë√£ ƒë∆∞·ª£c d√πng h·∫øt!');
                } else {
                     showGameOver('B·ªô t·ª´ v·ª±ng qu√° √≠t (d∆∞·ªõi 10 t·ª´) ho·∫∑c kh√¥ng c√≥ t·ª´!');
                }
                return;
            }
            
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            
            currentRound++;
            isGameActive = true;
            isHelpUsed = false; 
            helpButton.disabled = false;
            
            roundDisplay.textContent = `V√≤ng: ${currentRound}/${totalRounds}`;
            generateButton.textContent = '‚ú® B·ªè qua/T·∫°o l·∫°i T·ª´ M·ªõi'; 
            startPrompt.classList.add('hidden'); 
            
            charsContainer.innerHTML = '';
            currentSelected = null;
            selectedCharDisplay.textContent = 'Ch∆∞a c√≥';
            feedbackMessage.classList.add('hidden');

            targetCharObject = charData.target;

            // C·∫≠p nh·∫≠t m·ª•c ti√™u
            targetChineseMeaningDisplay.textContent = targetCharObject.meaning.toUpperCase();
            targetChinesePinyinDisplay.textContent = `(${targetCharObject.pinyin})`;

            // Ph√°t √¢m T·ª´ V·ª±ng m·ª•c ti√™u (s·ª≠ d·ª•ng MP3)
            speakChineseTextFromMP3(targetCharObject.char);


            // T·∫°o c√°c h√¨nh tr√≤n ch·ªØ H√°n/T·ª´ v·ª±ng
            charData.options.forEach(charObj => {
                const circle = document.createElement('div');
                // CH·ªà S·ª¨ D·ª§NG L·ªöP char-circle v√† font-medium
                circle.className = 'char-circle chinese-font flex items-center justify-center text-center rounded-full font-medium cursor-pointer p-1'; 
                circle.setAttribute('data-char', charObj.char);
                circle.textContent = charObj.char;
                circle.addEventListener('click', handleCharClick);

                charsContainer.appendChild(circle);
            });
            
            console.log(`[DEBUG] V√≤ng ${currentRound}/${totalRounds}. M·ª•c Ti√™u: ${targetCharObject.char} (${targetCharObject.meaning}). ƒê√£ d√πng ${usedTargetIndexes.size} t·ª´ v·ª±ng.`); 
        }

        /**
         * B·∫Øt ƒë·∫ßu m·ªôt game m·ªõi (reset t·∫•t c·∫£).
         */
        async function restartGame() {
            // T·∫£i d·ªØ li·ªáu b√†i h·ªçc m·ªõi nh·∫•t
            const lessonId = lessonSelector.value;
            showLoadingState(`ƒêang t·∫£i t·ª´ v·ª±ng cho ${lessonId}...`);

            try {
                const data = await fetchLessonData(lessonId);
                CHINESE_CHARACTERS = data;
                MAX_ROUNDS = CHINESE_CHARACTERS.length;
                
                // --- Thay ƒë·ªïi quan tr·ªçng: ƒê·∫∑t t·ªïng s·ªë v√≤ng ch∆°i c·ªë ƒë·ªãnh ---
                totalRounds = DEFAULT_ROUNDS; 
                // N·∫øu s·ªë t·ª´ v·ª±ng √≠t h∆°n m·∫∑c ƒë·ªãnh, gi·ªõi h·∫°n l·∫°i totalRounds
                if (MAX_ROUNDS < totalRounds) {
                    totalRounds = MAX_ROUNDS;
                }
                // --- K·∫øt th√∫c thay ƒë·ªïi ---

                // Ki·ªÉm tra ƒë·ªß t·ª´ v·ª±ng ƒë·ªÉ ch∆°i (c·∫ßn √≠t nh·∫•t 10 t·ª´ ƒë·ªÉ t·∫°o c√°c distractors)
                if (MAX_ROUNDS < OPTIONS_COUNT) {
                    showErrorState(`L·ªói: B√†i ${lessonId} ch·ªâ c√≥ ${MAX_ROUNDS} t·ª´. C·∫ßn t·ªëi thi·ªÉu ${OPTIONS_COUNT} t·ª´ ƒë·ªÉ ch∆°i.`);
                    return;
                }

                // Reset game state
                stopTimer(); 
                
                // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu s·ªë v√≤ng ch∆°i b·ªã gi·ªõi h·∫°n
                if (totalRounds < DEFAULT_ROUNDS) {
                    document.getElementById('feedback-message').textContent = `L∆∞u √Ω: Ch·ªâ c√≥ ${MAX_ROUNDS} t·ª´ v·ª±ng. S·ªë v√≤ng ch∆°i ƒë√£ ƒë∆∞·ª£c gi·ªõi h·∫°n th√†nh ${MAX_ROUNDS}.`;
                    document.getElementById('feedback-message').className = 'mb-8 p-4 text-center rounded-lg bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 font-semibold text-xl';
                    document.getElementById('feedback-message').classList.remove('hidden');
                } else {
                    document.getElementById('feedback-message').classList.add('hidden');
                }

                gameOverModal.classList.add('hidden');
                gameOverModal.classList.remove('flex');
                
                currentRound = 0;
                correctGuesses = 0;
                usedTargetIndexes.clear(); 
                isGameActive = true;
                
                startTimer(); 
                startNextRound();

            } catch (error) {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu b√†i h·ªçc:", error);
                showErrorState(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}. Vui l√≤ng ki·ªÉm tra file ${lessonId}/${lessonId}.txt.`);
            }
        }
        
        // --- C√ÅC H√ÄM TI·ªÜN √çCH UI ---
        
        // H√†m n√†y kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ s·ªë v√≤ng l√† c·ªë ƒë·ªãnh
        function updateRoundOptions(maxRounds) {
            // maxRoundsInfo.textContent = maxRounds; // ƒê√£ lo·∫°i b·ªè
            
            // C·∫≠p nh·∫≠t totalRounds d·ª±a tr√™n s·ªë t·ª´ v·ª±ng (N·∫øu √≠t h∆°n 10)
            totalRounds = Math.min(DEFAULT_ROUNDS, maxRounds);
        }

        function showLoadingState(message) {
            stopTimer();
            isGameActive = false;
            generateButton.textContent = 'ƒêang t·∫£i...';
            generateButton.disabled = true;
            helpButton.disabled = true;
            speakButton.disabled = true;
            targetChineseMeaningDisplay.textContent = message;
            targetChinesePinyinDisplay.textContent = '';
            charsContainer.innerHTML = '';
            startPrompt.classList.remove('hidden');
            startPrompt.textContent = message;
            roundDisplay.textContent = `V√≤ng: 0/${totalRounds}`; 
        }

        function showErrorState(message) {
             showLoadingState(message); // D√πng UI loading ƒë·ªÉ hi·ªÉn th·ªã l·ªói
             generateButton.textContent = '‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i';
             generateButton.disabled = false;
             targetChineseMeaningDisplay.textContent = 'L·ªñI T·∫¢I D·ªÆ LI·ªÜU';
             targetChinesePinyinDisplay.textContent = 'Vui l√≤ng ch·ªçn b√†i h·ªçc kh√°c';
             startPrompt.textContent = message;
        }

        /**
         * Thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫£i trang.
         */
        function initializeGameOnLoad() {
            // Kh√¥ng c·∫ßn t·∫£i voice, ch·ªâ d√πng MP3
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.body.classList.add('dark');
                document.getElementById('moon-icon').classList.remove('hidden');
                document.getElementById('sun-icon').classList.add('hidden');
            }
            
            // Kh·ªüi t·∫°o hi·ªÉn th·ªã ban ƒë·∫ßu
            lessonSelector.dispatchEvent(new Event('change'));
            
            // C·ªë ƒë·ªãnh totalRounds v√† th·ªùi gian
            totalRounds = DEFAULT_ROUNDS; 
            remainingTime = totalRounds * TIME_PER_ROUND;
            updateTimerDisplay(); 

            // Giao di·ªán tƒ©nh ban ƒë·∫ßu
            currentRound = 0;
            correctGuesses = 0;
            isGameActive = false;
            isHelpUsed = false;
            stopConfetti(); // Ph·∫£i d·ª´ng khi kh·ªüi t·∫°o
            stopTimer(); 

            roundDisplay.textContent = `V√≤ng: 0/${totalRounds}`; 
            scoreDisplay.textContent = `ƒê√∫ng: 0`;
            generateButton.textContent = '‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i';
            helpButton.disabled = true;
            speakButton.disabled = true;
            gameOverModal.classList.add('hidden');
            charsContainer.innerHTML = '';
            startPrompt.classList.remove('hidden');
            startPrompt.textContent = `Ch·ªçn B√†i h·ªçc v√† nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i!`; 
            targetChineseMeaningDisplay.textContent = 'Nh·∫•n B·∫Øt ƒë·∫ßu'; 
            targetChinesePinyinDisplay.textContent = ''; 
            selectedCharDisplay.textContent = 'Ch∆∞a c√≥';
            feedbackMessage.classList.add('hidden');

            // G√°n s·ª± ki·ªán cho c√°c n√∫t
            generateButton.addEventListener('click', restartGame);
            themeToggle.addEventListener('click', toggleTheme);
            helpButton.addEventListener('click', handleFiftyFiftyHelp);
            restartButtonModal.addEventListener('click', restartGame);
            
            // N√∫t Ph√°t √¢m b√¢y gi·ªù g·ªçi h√†m ph√°t MP3
            speakButton.addEventListener('click', () => {
                const text = targetCharObject ? targetCharObject.char : null;
                if (text) {
                    speakChineseTextFromMP3(text);
                }
            });

            // C·∫≠p nh·∫≠t khi ch·ªçn B√†i h·ªçc m·ªõi
            lessonSelector.addEventListener('change', async (e) => {
                const lessonId = e.target.value;
                showLoadingState(`ƒêang ki·ªÉm tra t·ª´ v·ª±ng cho ${lessonId}...`);
                
                try {
                    const data = await fetchLessonData(lessonId);
                    const newMaxRounds = data.length;
                    
                    updateRoundOptions(newMaxRounds); // C·∫≠p nh·∫≠t totalRounds d·ª±a tr√™n s·ªë t·ª´

                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã V√≤ng v√† prompt b·∫Øt ƒë·∫ßu
                    // totalRounds ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b√™n trong updateRoundOptions
                    remainingTime = totalRounds * TIME_PER_ROUND;
                    updateTimerDisplay();
                    
                    roundDisplay.textContent = `V√≤ng: 0/${totalRounds}`;
                    startPrompt.textContent = `ƒê√£ t·∫£i ${newMaxRounds} t·ª´. Ch∆°i ${totalRounds} v√≤ng. Nh·∫•n "B·∫Øt ƒë·∫ßu Tr√≤ ch∆°i" ƒë·ªÉ ch∆°i!`;
                    targetChineseMeaningDisplay.textContent = 'S·∫µn s√†ng';
                    targetChinesePinyinDisplay.textContent = `B√†i ${lessonId}`;

                    generateButton.disabled = false;
                    speakButton.disabled = true; // Ch·ªâ b·∫≠t khi c√≥ t·ª´ m·ª•c ti√™u
                    
                    // Reset tr·∫°ng th√°i ch∆°i
                    currentRound = 0;
                    correctGuesses = 0;
                    usedTargetIndexes.clear(); 
                    isGameActive = false;

                } catch (error) {
                     showErrorState(`L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`);
                }
            });
            
        }

        // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        window.onload = initializeGameOnLoad;
    </script>
</body>
</html>
